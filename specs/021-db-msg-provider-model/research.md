# Research: Database Message Persistence

**Feature**: `021-db-msg-provider-model`
**Date**: 2026-02-02

## 1. Database Schema & Migration

**Decision**: Modify `SQLiteChatMessageHistory` to support schema evolution via `alter table`.

**Rationale**: 
- `better-sqlite3` allows executing DDL.
- existing `migrateTable` method already implements this pattern for token usage columns.
- Adding nullable columns is a safe operation in SQLite and requires no downtime or complex copying (usually).

**Implementation Details**:
- Add `provider` text column.
- Add `model` text column.
- Update `migrateTable` list of columns.
- Update `INSERT` statement in `addMessage`.
- Update `SELECT` statement in `getMessages`.

## 2. Capturing Metadata in Agent

**Decision**: Inject metadata into `BaseMessage` objects within `Agent.chat()` loop.

**Rationale**:
- `Agent` holds the `MorpheusConfig` which contains specific `llm.provider` and `llm.model`.
- `SQLiteChatMessageHistory` is unaware of these values by default.
- We must bridge this gap at the call site (`Agent.chat`).

**Implementation Details**:
- Define a transient interface/type for metadata payload `{ provider: string, model: string }`.
- In `Agent.chat()`, attach this object to `UserMessage` and all generated `AIMessage`s before calling `history.addMessage()`.
- Use `(msg as any).provider_metadata` property to avoid breaking `BaseMessage` type strictness but allow transport.

## 3. Handling Read/Write

**Decision**: Persist as dedicated columns, rehydrate as properties.

**Rationale**: 
- Dedicated columns allow for SQL queries (GROUP BY provider) for future analytics.
- Rehydrating ensures the UI or other components can display "Generated by GPT-4" if needed.

**Alternatives Considered**:
- *storing in JSON blob*: Rejected. Makes SQL analytics hard.
- *storing in additional_kwargs*: Acceptable for transport, but dedicated columns preferred for first-class query support.

## Unknowns Resolution

- **Migration Safety**: `ALTER TABLE ADD COLUMN` is atomic in newer SQLite versions. No complex migration needed.
- **Model Info Source**: We will use `this.config.llm` as the source of truth for "Intended Model".

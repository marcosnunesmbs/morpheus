# Feature Specification: Database Message Persistence for Provider and Model

**Feature Branch**: `021-db-msg-provider-model`
**Created**: 2026-02-02
**Status**: Draft
**Input**: MNU-5 - Database messages save model and provider

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Message Metadata Persistence (Priority: P1)

As a developer/analyst, I want new chat messages to be stored with the AI provider and model name used to generate them, so that I can audit usage and cost tracking per provider.

**Why this priority**: Core requirement for data integrity and future analytics (MNU-5).

**Independent Test**: Send a message using a specific agent config (e.g., OpenAI/GPT-4o), then inspect the data store to verify the `provider` and `model` fields are populated correctly.

**Acceptance Scenarios**:

1. **Given** a configured agent (e.g., Provider: OpenAI, Model: gpt-4o), **When** a user sends a message and the agent responds, **Then** both the user message and AI response are saved in the `messages` table with `provider='openai'` (or similar) and `model='gpt-4o'`.
2. **Given** a system message or internal event, **When** it is logged to chat history, **Then** it is saved, potentially with null or system-defined provider/model if applicable.

### User Story 2 - Database Schema Migration (Priority: P1)

As a system administrator, I want the database schema to automatically update when I upgrade Morpheus, so that my existing chat history is preserved while enabling new fields.

**Why this priority**: Essential to prevent crashes or data corruption for existing users.

**Independent Test**: Start the application against an existing older database. Verify the application starts without error and the `messages` table schema has the new fields.

**Acceptance Scenarios**:

1. **Given** an existing data store without the new fields, **When** the application starts, **Then** a migration runs successfully, adding `provider` and `model` fields.
2. **Given** existing messages, **When** the migration completes, **Then** existing rows have `NULL` (or default) values for the new fields, and data access remains valid.

### Edge Cases

- **Existing Data**: Old messages will have NULL provider/model. Code reading these must handle NULLs gracefully.
- **Provider Switch**: If user changes provider mid-session, new messages reflect the new provider/model immediately.
- **Unknown Provider**: If a message is generated by a tool or system logic without an LLM, provider/model should be NULL or "system".

## Assumptions & Dependencies *(optional)*

*   **Assumption**: The underlying data store supports schema modifications (e.g. ADD COLUMN).
*   **Dependency**: The application has access to the active agent configuration at the point of message persistence.
*   **Dependency**: A migration framework or logic exists to handle schema updates on startup.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST update the data storage schema for messages to include `provider` and `model` fields (text).
- **FR-002**: System MUST run a migration on startup to add these fields if they are missing.
- **FR-003**: System MUST capture the active Agent's provider (e.g., 'openai') and model (e.g., 'gpt-4') during message generation.
- **FR-004**: System MUST persist the captured provider and model values when saving messages to the data store.
- **FR-005**: System MUST handle NULL values for `provider` and `model` when retrieving historical messages.

### Key Entities

- **Message**: Represents a chat message. Updated to include `provider` (string, nullable) and `model` (string, nullable).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% of newly generated AI messages have valid `provider` and `model` non-null values in the database.
- **SC-002**: Database migration succeeds on existing databases with 0 data loss.
- **SC-003**: Application startup time increases by no more than 1 second due to migration checks.
